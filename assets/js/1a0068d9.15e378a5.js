"use strict";(self.webpackChunktrevas_documentation=self.webpackChunktrevas_documentation||[]).push([[8142],{67557:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"developer-guide/spark-mode/index-spark-mode","title":"Spark mode","description":"SparkDataset","source":"@site/docs/developer-guide/spark-mode/index-spark-mode.mdx","sourceDirName":"developer-guide/spark-mode","slug":"/developer-guide/spark-mode","permalink":"/Trevas/developer-guide/spark-mode","draft":false,"unlisted":false,"editUrl":null,"tags":[],"version":"current","lastUpdatedAt":1753116911000,"frontMatter":{"id":"index-spark-mode","title":"Spark mode","sidebar_label":"Overview","slug":"/developer-guide/spark-mode","custom_edit_url":null},"sidebar":"docs","previous":{"title":"Others","permalink":"/Trevas/developer-guide/basic-mode/data-sources/others"},"next":{"title":"Overview","permalink":"/Trevas/developer-guide/spark-mode/data-sources"}}');var t=r(74848),a=r(28453);const i={id:"index-spark-mode",title:"Spark mode",sidebar_label:"Overview",slug:"/developer-guide/spark-mode",custom_edit_url:null},o=void 0,d={},l=[{value:"SparkDataset",id:"sparkdataset",level:3},{value:"Import Trevas Spark module",id:"import-trevas-spark-module",level:3},{value:"Spark session",id:"spark-session",level:3},{value:"Example",id:"example",level:3},{value:"Distributed execution",id:"distributed-execution",level:3},{value:"Execution in a Kubernetes cluster",id:"execution-in-a-kubernetes-cluster",level:3}];function p(e){const n={a:"a",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h3,{id:"sparkdataset",children:"SparkDataset"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"SparkDataset"})," data sets can represent statistical tables in a Java application using Trevas in Spark mode."]}),"\n",(0,t.jsx)(n.h3,{id:"import-trevas-spark-module",children:"Import Trevas Spark module"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>fr.insee.trevas</groupId>\n    <artifactId>vtl-spark</artifactId>\n    <version>1.10.0</version>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"spark-session",children:"Spark session"}),"\n",(0,t.jsx)(n.p,{children:"In order to execute VTL via Trevas in Spark mode, a Spark session must be instantiated."}),"\n",(0,t.jsx)(n.p,{children:"The session can be:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"locale (execution on the Java server)"}),"\n",(0,t.jsx)(n.li,{children:"static (execution on a Spark instance installed on a server beforehand)"}),"\n",(0,t.jsx)(n.li,{children:"dynamic (dynamic execution on a Kubernetes cluster)"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'SparkSession spark = SparkSession.builder().master("local").getOrCreate();\n'})}),"\n",(0,t.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'ScriptEngine engine = new ScriptEngineManager().getEngineByName("vtl");\n\nBindings bindings = new SimpleBindings();\nSparkDataset dataset = new SparkDataset(spark.read().parquet("folder_path"));\nbindings.put("myDataset", dataset);\n\nengine.getContext().setBindings(bindings, ScriptContext.ENGINE_SCOPE);\nengine.put("$vtl.engine.processing_engine_names", "spark");\nengine.put("$vtl.spark.session", spark);\n\nString script = "res := myDataset[filter var3 > 6];";\n\ntry {\n    engine.eval(script);\n} catch (ScriptException e) {\n    e.printStackTrace();\n}\n\nBindings outputBindings = engine.getContext().getBindings(ScriptContext.ENGINE_SCOPE);\nSparkDataset result = (SparkDataset) outputBindings.get("res");\n// Ensure direct resolution because of spark lazy mechanism (performance warning!)\nInMemoryDataset imResult = new InMemoryDataset(\n                        result.getDataPoints(),\n                        result.getDataStructure()\n                    );\n'})}),"\n",(0,t.jsx)(n.h3,{id:"distributed-execution",children:"Distributed execution"}),"\n",(0,t.jsx)(n.p,{children:"Whether in static or dynamic mode, the distributed execution of the treatments requires that the executors instantiated by the master be able to solve the VTL processing."}),"\n",(0,t.jsxs)(n.p,{children:["It is thus necessary to provide the Trevas jars to the executors via the ",(0,t.jsx)(n.code,{children:"spark.jars"})," option of the ",(0,t.jsx)(n.code,{children:"SparkConf"})," object:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.jars", String.join(",",\n                    "/vtl-spark.jar",\n                    "/vtl-model.jar",\n                    "/vtl-parser.jar",\n                    "/vtl-engine.jar",\n            ));\nsparkBuilder.config(conf);\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})}),"\n",(0,t.jsx)(n.h3,{id:"execution-in-a-kubernetes-cluster",children:"Execution in a Kubernetes cluster"}),"\n",(0,t.jsxs)(n.p,{children:["Many options are detailed in the ",(0,t.jsx)(n.a,{href:"https://spark.apache.org/docs/latest/running-on-kubernetes.html#docker-images",children:"official documentation"})]}),"\n",(0,t.jsx)(n.p,{children:"Among these, one option is particularly important: the Docker image that will allow executors to resolve VTL processing."}),"\n",(0,t.jsxs)(n.p,{children:["A custom image is available ",(0,t.jsx)(n.a,{href:"https://github.com/InseeFrLab/Trevas-Spark-Hadoop",children:"here"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.kubernetes.container.image", "inseefrlab/spark-hadoop:trevas-0.4.7-spark-3.2.1-hadoop-3.3.1-postgresql-42.3.3-postgis-2021.1.0");\nconf.set("spark.kubernetes.container.pullPolicy", "IfNotPresent");\nsparkBuilder.config(conf);\nsparkBuilder.master("k8s://...")\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var s=r(96540);const t={},a=s.createContext(t);function i(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);