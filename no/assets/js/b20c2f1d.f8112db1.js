"use strict";(self.webpackChunktrevas_documentation=self.webpackChunktrevas_documentation||[]).push([[8587],{95696:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"developer-guide/spark-mode/index-spark-mode","title":"Spark modus","description":"SparkDataset","source":"@site/i18n/no/docusaurus-plugin-content-docs/current/developer-guide/spark-mode/index-spark-mode.mdx","sourceDirName":"developer-guide/spark-mode","slug":"/developer-guide/spark-mode","permalink":"/Trevas/no/developer-guide/spark-mode","draft":false,"unlisted":false,"editUrl":null,"tags":[],"version":"current","lastUpdatedAt":1754249375000,"frontMatter":{"id":"index-spark-mode","title":"Spark modus","sidebar_label":"Oversikt","slug":"/developer-guide/spark-mode","custom_edit_url":null},"sidebar":"docs","previous":{"title":"Andre","permalink":"/Trevas/no/developer-guide/basic-mode/data-sources/others"},"next":{"title":"Oversikt","permalink":"/Trevas/no/developer-guide/spark-mode/data-sources"}}');var t=n(74848),a=n(28453);const i={id:"index-spark-mode",title:"Spark modus",sidebar_label:"Oversikt",slug:"/developer-guide/spark-mode",custom_edit_url:null},l=void 0,d={},o=[{value:"SparkDataset",id:"sparkdataset",level:3},{value:"Importer Spark-modul fra Trevas",id:"importer-spark-modul-fra-trevas",level:3},{value:"Session Spark",id:"session-spark",level:3},{value:"Eksempel",id:"eksempel",level:3},{value:"Distribuert utf\xf8relse",id:"distribuert-utf\xf8relse",level:3},{value:"Kj\xf8rer i en Kubernetes klynge",id:"kj\xf8rer-i-en-kubernetes-klynge",level:3}];function p(e){const r={a:"a",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h3,{id:"sparkdataset",children:"SparkDataset"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"SparkDataset"})," datasett brukes til \xe5 representere statistiske tabeller i en Java-applikasjon som bruker Trevas i Spark-modus."]}),"\n",(0,t.jsx)(r.h3,{id:"importer-spark-modul-fra-trevas",children:"Importer Spark-modul fra Trevas"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-xml",children:"<dependency>\n    <groupId>fr.insee.trevas</groupId>\n    <artifactId>vtl-spark</artifactId>\n    <version>1.11.0</version>\n</dependency>\n"})}),"\n",(0,t.jsx)(r.h3,{id:"session-spark",children:"Session Spark"}),"\n",(0,t.jsx)(r.p,{children:"For \xe5 kj\xf8re VTL via Trevas i Spark-modus, m\xe5 du instansiere en Spark-\xf8kt."}),"\n",(0,t.jsx)(r.p,{children:"\xd8kten kan v\xe6re :"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"lokal (kj\xf8rer p\xe5 Java-serveren)"}),"\n",(0,t.jsx)(r.li,{children:"statisk (kj\xf8rer p\xe5 en Spark-forekomst som tidligere er installert p\xe5 en server)"}),"\n",(0,t.jsx)(r.li,{children:"dynamisk (kj\xf8rer dynamisk i en Kubernetes-klynge)"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'SparkSession spark = SparkSession.builder().master("local").getOrCreate();\n'})}),"\n",(0,t.jsx)(r.h3,{id:"eksempel",children:"Eksempel"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'ScriptEngine engine = new ScriptEngineManager().getEngineByName("vtl");\n\nBindings bindings = new SimpleBindings();\nSparkDataset dataset = new SparkDataset(spark.read().parquet("folder_path"));\nbindings.put("myDataset", dataset);\n\nengine.getContext().setBindings(bindings, ScriptContext.ENGINE_SCOPE);\nengine.put("$vtl.engine.processing_engine_names", "spark");\nengine.put("$vtl.spark.session", spark);\n\nString script = "res := myDataset[filter var3 > 6];";\n\ntry {\n    engine.eval(script);\n} catch (ScriptException e) {\n    e.printStackTrace();\n}\n\nBindings outputBindings = engine.getContext().getBindings(ScriptContext.ENGINE_SCOPE);\nSparkDataset result = (SparkDataset) outputBindings.get("res");\n// Ensure direct resolution because of spark lazy mechanism (performance warning!)\nInMemoryDataset imResult = new InMemoryDataset(\n                        result.getDataPoints(),\n                        result.getDataStructure()\n                    );\n'})}),"\n",(0,t.jsx)(r.h3,{id:"distribuert-utf\xf8relse",children:"Distribuert utf\xf8relse"}),"\n",(0,t.jsx)(r.p,{children:"Enten i statisk eller dynamisk modus, den distribuerte utf\xf8relse av prosessering krever at eksekut\xf8rene instansiert av masteren er i stand til \xe5 l\xf8se VTL-behandlingen."}),"\n",(0,t.jsxs)(r.p,{children:["Det er da n\xf8dvendig \xe5 gi Trevas-krukkene til utf\xf8rerne via ",(0,t.jsx)(r.code,{children:"spark.jars"})," alternativet til ",(0,t.jsx)(r.code,{children:"SparkConf"})," objektet :"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.jars", String.join(",",\n                    "/vtl-spark.jar",\n                    "/vtl-model.jar",\n                    "/vtl-parser.jar",\n                    "/vtl-engine.jar",\n            ));\nsparkBuilder.config(conf);\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})}),"\n",(0,t.jsx)(r.h3,{id:"kj\xf8rer-i-en-kubernetes-klynge",children:"Kj\xf8rer i en Kubernetes klynge"}),"\n",(0,t.jsxs)(r.p,{children:["Mange alternativer er beskrevet i den ",(0,t.jsx)(r.a,{href:"https://spark.apache.org/docs/latest/running-on-kubernetes.html#docker-images",children:"offisielle dokumentasjonen"})]}),"\n",(0,t.jsx)(r.p,{children:"Blant disse er ett alternativ spesielt viktig: Docker-bildet som vil tillate eksekut\xf8rer \xe5 l\xf8se VTL-behandling."}),"\n",(0,t.jsxs)(r.p,{children:["Et tilpasset bilde er tilgjengelig ",(0,t.jsx)(r.a,{href:"https://github.com/InseeFrLab/Trevas-Spark-Hadoop",children:"her"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.kubernetes.container.image", "inseefrlab/spark-hadoop:trevas-0.4.7-spark-3.2.1-hadoop-3.3.1-postgresql-42.3.3-postgis-2021.1.0");\nconf.set("spark.kubernetes.container.pullPolicy", "IfNotPresent");\nsparkBuilder.config(conf);\nsparkBuilder.master("k8s://...")\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})})]})}function u(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},28453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>l});var s=n(96540);const t={},a=s.createContext(t);function i(e){const r=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(a.Provider,{value:r},e.children)}}}]);