"use strict";(self.webpackChunktrevas_documentation=self.webpackChunktrevas_documentation||[]).push([[6851],{38816:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>d,toc:()=>o});var s=r(74848),t=r(28453);const a={id:"index-spark-mode",title:"Mode Spark",sidebar_label:"Vue d'ensemble",slug:"/developer-guide/spark-mode",custom_edit_url:null},i=void 0,d={id:"developer-guide/spark-mode/index-spark-mode",title:"Mode Spark",description:"SparkDataset",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/developer-guide/spark-mode/index-spark-mode.mdx",sourceDirName:"developer-guide/spark-mode",slug:"/developer-guide/spark-mode",permalink:"/Trevas/fr/developer-guide/spark-mode",draft:!1,unlisted:!1,editUrl:null,tags:[],version:"current",lastUpdatedAt:1731403926e3,frontMatter:{id:"index-spark-mode",title:"Mode Spark",sidebar_label:"Vue d'ensemble",slug:"/developer-guide/spark-mode",custom_edit_url:null},sidebar:"docs",previous:{title:"Others",permalink:"/Trevas/fr/developer-guide/basic-mode/data-sources/others"},next:{title:"Vue d'ensemble",permalink:"/Trevas/fr/developer-guide/spark-mode/data-sources"}},l={},o=[{value:"SparkDataset",id:"sparkdataset",level:3},{value:"Importer le module Spark de Trevas",id:"importer-le-module-spark-de-trevas",level:3},{value:"Session Spark",id:"session-spark",level:3},{value:"Exemple",id:"exemple",level:3},{value:"Ex\xe9cution distribu\xe9e",id:"ex\xe9cution-distribu\xe9e",level:3},{value:"Ex\xe9cution dans un cluster Kubernetes",id:"ex\xe9cution-dans-un-cluster-kubernetes",level:3}];function u(e){const n={a:"a",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"sparkdataset",children:"SparkDataset"}),"\n",(0,s.jsxs)(n.p,{children:["Les datasets ",(0,s.jsx)(n.code,{children:"SparkDataset"})," permettent de repr\xe9senter les tables statistiques dans une application Java utilisant Trevas en mode Spark."]}),"\n",(0,s.jsx)(n.h3,{id:"importer-le-module-spark-de-trevas",children:"Importer le module Spark de Trevas"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>fr.insee.trevas</groupId>\n    <artifactId>vtl-spark</artifactId>\n    <version>1.7.0</version>\n</dependency>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"session-spark",children:"Session Spark"}),"\n",(0,s.jsx)(n.p,{children:"Afin d'ex\xe9cuter du VTL via Trevas en mode Spark, il faut instancier une session Spark."}),"\n",(0,s.jsx)(n.p,{children:"La session peut \xeatre :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"locale (ex\xe9cution sur le serveur Java)"}),"\n",(0,s.jsx)(n.li,{children:"statique (ex\xe9cution sur une instance Spark pr\xe9alablement install\xe9e sur un serveur)"}),"\n",(0,s.jsx)(n.li,{children:"dynamique (ex\xe9cution dynamique au sein d'un cluster Kubernetes)"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'SparkSession spark = SparkSession.builder().master("local").getOrCreate();\n'})}),"\n",(0,s.jsx)(n.h3,{id:"exemple",children:"Exemple"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'ScriptEngine engine = new ScriptEngineManager().getEngineByName("vtl");\n\nBindings bindings = new SimpleBindings();\nSparkDataset dataset = new SparkDataset(spark.read().parquet("folder_path"));\nbindings.put("myDataset", dataset);\n\nengine.getContext().setBindings(bindings, ScriptContext.ENGINE_SCOPE);\nengine.put("$vtl.engine.processing_engine_names", "spark");\nengine.put("$vtl.spark.session", spark);\n\nString script = "res := myDataset[filter var3 > 6];";\n\ntry {\n    engine.eval(script);\n} catch (ScriptException e) {\n    e.printStackTrace();\n}\n\nBindings outputBindings = engine.getContext().getBindings(ScriptContext.ENGINE_SCOPE);\nSparkDataset result = (SparkDataset) outputBindings.get("res");\n// Ensure direct resolution because of spark lazy mechanism (performance warning!)\nInMemoryDataset imResult = new InMemoryDataset(\n                        result.getDataPoints(),\n                        result.getDataStructure()\n                    );\n'})}),"\n",(0,s.jsx)(n.h3,{id:"ex\xe9cution-distribu\xe9e",children:"Ex\xe9cution distribu\xe9e"}),"\n",(0,s.jsx)(n.p,{children:"Que ce soit en mode statique ou dynamique, l'\xe9xecution distribu\xe9e des traitements n\xe9cessite que les ex\xe9cuteurs instanci\xe9s par le master soient en capacit\xe9 de r\xe9soudre les traitements VTL."}),"\n",(0,s.jsxs)(n.p,{children:["Il faut alors fournir les jar Trevas aux ex\xe9cuteurs via l'options ",(0,s.jsx)(n.code,{children:"spark.jars"})," de l'objet ",(0,s.jsx)(n.code,{children:"SparkConf"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.jars", String.join(",",\n                    "/vtl-spark.jar",\n                    "/vtl-model.jar",\n                    "/vtl-parser.jar",\n                    "/vtl-engine.jar",\n            ));\nsparkBuilder.config(conf);\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})}),"\n",(0,s.jsx)(n.h3,{id:"ex\xe9cution-dans-un-cluster-kubernetes",children:"Ex\xe9cution dans un cluster Kubernetes"}),"\n",(0,s.jsxs)(n.p,{children:["De nombreuses options sont d\xe9taill\xe9es dans la ",(0,s.jsx)(n.a,{href:"https://spark.apache.org/docs/latest/running-on-kubernetes.html#docker-images",children:"documentation officielle"})]}),"\n",(0,s.jsx)(n.p,{children:"Parmi celles-ci, une option est particuli\xe8rement importante : l'image Docker qui permettra au ex\xe9cuteurs de r\xe9soudre les traitements VTL."}),"\n",(0,s.jsxs)(n.p,{children:["Une image \xe0 fa\xe7on est disponible ",(0,s.jsx)(n.a,{href:"https://github.com/InseeFrLab/Trevas-Spark-Hadoop",children:"ici"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'SparkSession.Builder sparkBuilder = SparkSession.builder()\nSparkConf conf = new SparkConf();\nconf.set("spark.kubernetes.container.image", "inseefrlab/spark-hadoop:trevas-0.4.7-spark-3.2.1-hadoop-3.3.1-postgresql-42.3.3-postgis-2021.1.0");\nconf.set("spark.kubernetes.container.pullPolicy", "IfNotPresent");\nsparkBuilder.config(conf);\nsparkBuilder.master("k8s://...")\n...\nSparkSession spark = sparkBuilder.getOrCreate();\n'})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>d});var s=r(96540);const t={},a=s.createContext(t);function i(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);